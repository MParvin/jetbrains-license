<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VM选项配置 - JetBrains License Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .product-card {
            transition: all 0.3s ease;
            border: 2px solid #dee2e6;
            cursor: pointer;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .product-card.selected {
            border-color: #0d6efd;
            background-color: #e7f3ff;
        }
        .product-card.available {
            border-left: 4px solid #28a745;
        }
        .product-card.unavailable {
            border-left: 4px solid #dc3545;
            opacity: 0.7;
        }
        .custom-path-input {
            display: none;
            margin-top: 10px;
        }
        .custom-path-input.show {
            display: block;
        }
        .jar-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .selection-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .path-config-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-key me-2"></i>JetBrains License Generator
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>首页
                </a>
                <a class="nav-link" href="/config">
                    <i class="fas fa-cog me-1"></i>配置
                </a>
                <a class="nav-link active" href="/vmoptions">
                    <i class="fas fa-tools me-1"></i>VM选项
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 页面标题 -->
        <div class="row mb-4">
            <div class="col-12">
                <h2><i class="fas fa-cogs text-primary me-2"></i>VM选项配置</h2>
                <p class="text-muted">选择需要配置的产品和自定义路径，灵活配置JetBrains产品的VM选项</p>
            </div>
        </div>

        <!-- ja-netfilter.jar 信息 -->
        <div class="jar-info">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4><i class="fas fa-file-archive me-2"></i>ja-netfilter.jar 配置</h4>
                    <p class="mb-2"><strong>默认路径:</strong> <code th:text="${jaNetfilterInfo.path}"></code></p>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="useCustomJarPath">
                        <label class="form-check-label text-white" for="useCustomJarPath">
                            使用自定义jar路径
                        </label>
                    </div>
                    <div id="customJarPathInput" class="custom-path-input">
                        <div class="input-group">
                            <input type="text" class="form-control" id="customJarPath"
                                   placeholder="选择ja-netfilter.jar文件" readonly>
                            <button class="btn btn-outline-light" type="button" onclick="selectJarFile()">
                                <i class="fas fa-folder-open me-1"></i>浏览
                            </button>
                        </div>
                        <input type="file" id="jarFileInput" accept=".jar" style="display: none;">
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <span th:if="${isJaNetfilterAvailable}" class="badge bg-success fs-6">
                        <i class="fas fa-check-circle me-1"></i>默认文件存在
                    </span>
                    <span th:unless="${isJaNetfilterAvailable}" class="badge bg-warning fs-6">
                        <i class="fas fa-exclamation-triangle me-1"></i>默认文件不存在
                    </span>
                </div>
            </div>
        </div>

        <!-- 产品选择区域 -->
        <div class="row mb-4">
            <div class="col-12">
                <h4><i class="fas fa-check-square text-info me-2"></i>选择要配置的产品</h4>
                <p class="text-muted">点击产品卡片进行选择，支持多选</p>
                <div class="mb-3">
                    <button type="button" class="btn btn-outline-primary btn-sm me-2" onclick="selectAllProducts()">
                        <i class="fas fa-check-double me-1"></i>全选
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm me-2" onclick="clearAllProducts()">
                        <i class="fas fa-times me-1"></i>清空
                    </button>
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="selectAvailableProducts()">
                        <i class="fas fa-filter me-1"></i>仅选择可用产品
                    </button>
                </div>
            </div>
        </div>

        <!-- 产品列表 -->
        <div class="row mb-4">
            <div class="col-md-4 col-lg-3 mb-3" th:each="product : ${supportedProducts}">
                <div class="card product-card h-100" 
                     th:classappend="${product.available == 'true'} ? 'available' : 'unavailable'"
                     th:data-product="${product.key}"
                     th:data-available="${product.available}"
                     onclick="toggleProduct(this)">
                    <div class="card-body text-center">
                        <div class="position-relative">
                            <i class="fas fa-laptop-code fa-2x text-primary mb-3"></i>
                            <div class="position-absolute top-0 end-0">
                                <i class="fas fa-check-circle text-success selection-icon" style="display: none;"></i>
                            </div>
                        </div>
                        <h6 class="card-title" th:text="${product.name}"></h6>
                        <small class="text-muted" th:text="${product.key}"></small>
                        <div class="mt-2">
                            <small th:if="${product.available == 'true'}" class="text-success">
                                <i class="fas fa-check-circle me-1"></i>配置文件可用
                            </small>
                            <small th:unless="${product.available == 'true'}" class="text-muted">
                                <i class="fas fa-minus-circle me-1"></i>配置文件不存在
                            </small>
                        </div>
                        
                        <!-- 自定义路径选项 -->
                        <div class="mt-2">
                            <div class="form-check">
                                <input class="form-check-input custom-path-checkbox" type="checkbox"
                                       th:id="'customPath_' + ${product.key}"
                                       onclick="event.stopPropagation(); toggleCustomPath(this)">
                                <label class="form-check-label small" th:for="'customPath_' + ${product.key}">
                                    自定义路径
                                </label>
                            </div>
                            <div class="custom-path-input" th:id="'customPathInput_' + ${product.key}">
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control"
                                           th:id="'customPathValue_' + ${product.key}"
                                           placeholder="选择vmoptions文件"
                                           readonly
                                           onclick="event.stopPropagation()">
                                    <button class="btn btn-outline-secondary btn-sm" type="button"
                                            th:onclick="'selectVmOptionsFile(\\'' + ${product.key} + '\\')'"
                                            onclick="event.stopPropagation()">
                                        <i class="fas fa-folder-open"></i>
                                    </button>
                                </div>
                                <input type="file" th:id="'vmOptionsFileInput_' + ${product.key}"
                                       accept=".vmoptions" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 选择摘要 -->
        <div class="selection-summary">
            <h5><i class="fas fa-list-check text-primary me-2"></i>配置摘要</h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>已选择产品:</strong> <span id="selectedCount">0</span> 个</p>
                    <div id="selectedProductsList" class="small text-muted">未选择任何产品</div>
                </div>
                <div class="col-md-6">
                    <p><strong>自定义路径:</strong> <span id="customPathCount">0</span> 个</p>
                    <div id="customPathsList" class="small text-muted">未设置自定义路径</div>
                </div>
            </div>
        </div>

        <!-- 配置按钮 -->
        <div class="text-center mb-4">
            <button type="button" class="btn btn-primary btn-lg me-3" onclick="configureAllProducts()" id="configureAllBtn">
                <i class="fas fa-magic me-2"></i>配置所有产品
            </button>
            <button type="button" class="btn btn-success btn-lg" onclick="configureSelectedProducts()" id="configureSelectedBtn" disabled>
                <i class="fas fa-rocket me-2"></i>配置选定产品
            </button>
        </div>

        <!-- 配置结果显示区域 -->
        <div id="configResult" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clipboard-list me-2"></i>配置结果</h5>
                </div>
                <div class="card-body">
                    <div id="resultContent"></div>
                </div>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle text-info me-2"></i>高级配置说明</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>产品选择</h6>
                                <ul class="small">
                                    <li>点击产品卡片进行选择/取消选择</li>
                                    <li>支持多选，可以同时配置多个产品</li>
                                    <li>绿色边框表示配置文件可用</li>
                                    <li>红色边框表示配置文件不存在</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>路径配置</h6>
                                <ul class="small">
                                    <li>可以自定义ja-netfilter.jar路径</li>
                                    <li>可以为每个产品设置自定义vmoptions路径</li>
                                    <li>留空则使用默认路径</li>
                                    <li>支持绝对路径和相对路径</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedProducts = new Set();
        
        // 切换自定义jar路径输入
        document.getElementById('useCustomJarPath').addEventListener('change', function() {
            const input = document.getElementById('customJarPathInput');
            if (this.checked) {
                input.classList.add('show');
            } else {
                input.classList.remove('show');
                document.getElementById('customJarPath').value = '';
            }
        });

        // jar文件选择
        document.getElementById('jarFileInput').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                document.getElementById('customJarPath').value = file.name;
                // 在实际应用中，这里应该获取文件的完整路径
                // 由于浏览器安全限制，我们只能显示文件名
            }
        });

        // 选择jar文件
        function selectJarFile() {
            document.getElementById('jarFileInput').click();
        }

        // 选择vmoptions文件
        function selectVmOptionsFile(productKey) {
            document.getElementById('vmOptionsFileInput_' + productKey).click();
        }

        // 为每个产品的文件输入添加事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            const products = ['idea', 'clion', 'phpstorm', 'goland', 'pycharm', 'webstorm',
                            'webide', 'rider', 'datagrip', 'rubymine', 'appcode', 'dataspell',
                            'gateway', 'jetbrains_client', 'jetbrainsclient', 'studio', 'devecostudio'];

            products.forEach(product => {
                const fileInput = document.getElementById('vmOptionsFileInput_' + product);
                if (fileInput) {
                    fileInput.addEventListener('change', function() {
                        const file = this.files[0];
                        if (file) {
                            document.getElementById('customPathValue_' + product).value = file.name;
                        }
                    });
                }
            });
        });
        
        // 切换产品选择
        function toggleProduct(card) {
            const productKey = card.dataset.product;
            const selectionIcon = card.querySelector('.selection-icon');
            
            if (selectedProducts.has(productKey)) {
                selectedProducts.delete(productKey);
                card.classList.remove('selected');
                selectionIcon.style.display = 'none';
            } else {
                selectedProducts.add(productKey);
                card.classList.add('selected');
                selectionIcon.style.display = 'block';
            }
            
            updateSelectionSummary();
        }
        
        // 切换自定义路径输入
        function toggleCustomPath(checkbox) {
            const productKey = checkbox.id.replace('customPath_', '');
            const input = document.getElementById('customPathInput_' + productKey);
            
            if (checkbox.checked) {
                input.classList.add('show');
            } else {
                input.classList.remove('show');
                document.getElementById('customPathValue_' + productKey).value = '';
            }
            
            updateSelectionSummary();
        }
        
        // 全选产品
        function selectAllProducts() {
            document.querySelectorAll('.product-card').forEach(card => {
                const productKey = card.dataset.product;
                if (!selectedProducts.has(productKey)) {
                    selectedProducts.add(productKey);
                    card.classList.add('selected');
                    card.querySelector('.selection-icon').style.display = 'block';
                }
            });
            updateSelectionSummary();
        }
        
        // 清空选择
        function clearAllProducts() {
            selectedProducts.clear();
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.selection-icon').style.display = 'none';
            });
            updateSelectionSummary();
        }
        
        // 仅选择可用产品
        function selectAvailableProducts() {
            clearAllProducts();
            document.querySelectorAll('.product-card[data-available="true"]').forEach(card => {
                const productKey = card.dataset.product;
                selectedProducts.add(productKey);
                card.classList.add('selected');
                card.querySelector('.selection-icon').style.display = 'block';
            });
            updateSelectionSummary();
        }
        
        // 更新选择摘要
        function updateSelectionSummary() {
            const selectedCount = selectedProducts.size;
            document.getElementById('selectedCount').textContent = selectedCount;
            document.getElementById('configureSelectedBtn').disabled = selectedCount === 0;
            
            // 更新选择的产品列表
            if (selectedCount > 0) {
                const productNames = Array.from(selectedProducts).map(key => {
                    const card = document.querySelector(`[data-product="${key}"]`);
                    return card.querySelector('.card-title').textContent;
                });
                document.getElementById('selectedProductsList').innerHTML = 
                    productNames.map(name => `<span class="badge bg-primary me-1">${name}</span>`).join('');
            } else {
                document.getElementById('selectedProductsList').textContent = '未选择任何产品';
            }
            
            // 更新自定义路径统计
            const customPaths = document.querySelectorAll('.custom-path-checkbox:checked');
            document.getElementById('customPathCount').textContent = customPaths.length;
            
            if (customPaths.length > 0) {
                const pathList = Array.from(customPaths).map(checkbox => {
                    const productKey = checkbox.id.replace('customPath_', '');
                    const card = document.querySelector(`[data-product="${productKey}"]`);
                    return card.querySelector('.card-title').textContent;
                });
                document.getElementById('customPathsList').innerHTML = 
                    pathList.map(name => `<span class="badge bg-warning me-1">${name}</span>`).join('');
            } else {
                document.getElementById('customPathsList').textContent = '未设置自定义路径';
            }
        }

        // 配置所有产品
        function configureAllProducts() {
            const button = document.getElementById('configureAllBtn');
            const originalText = button.innerHTML;

            // 显示加载状态
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>配置中...';

            // 准备请求数据
            const requestData = {
                selectedProducts: [], // 空数组表示配置所有产品
                customJarPath: document.getElementById('useCustomJarPath').checked ?
                    getJarFilePath() : null,
                customVmOptionsMap: {}
            };

            executeConfiguration(requestData, button, originalText);
        }

        // 配置选定产品
        function configureSelectedProducts() {
            if (selectedProducts.size === 0) {
                alert('请至少选择一个产品');
                return;
            }

            const button = document.getElementById('configureSelectedBtn');
            const originalText = button.innerHTML;

            // 显示加载状态
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>配置中...';

            // 准备请求数据
            const requestData = {
                selectedProducts: Array.from(selectedProducts),
                customJarPath: document.getElementById('useCustomJarPath').checked ?
                    getJarFilePath() : null,
                customVmOptionsMap: {}
            };

            // 收集自定义vmoptions路径
            document.querySelectorAll('.custom-path-checkbox:checked').forEach(checkbox => {
                const productKey = checkbox.id.replace('customPath_', '');
                const pathValue = getVmOptionsFilePath(productKey);
                if (pathValue) {
                    requestData.customVmOptionsMap[productKey] = pathValue;
                }
            });

            executeConfiguration(requestData, button, originalText);
        }

        // 执行配置请求
        function executeConfiguration(requestData, button, originalText) {
            fetch('/api/vmoptions/configure', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                showConfigResult(data);
            })
            .catch(error => {
                console.error('配置失败:', error);
                showConfigResult({
                    success: false,
                    message: '配置失败: ' + error.message
                });
            })
            .finally(() => {
                // 恢复按钮状态
                button.disabled = false;
                button.innerHTML = originalText;
            });
        }

        // 获取jar文件路径
        function getJarFilePath() {
            const jarInput = document.getElementById('customJarPath');
            return jarInput.value.trim() || null;
        }

        // 获取vmoptions文件路径
        function getVmOptionsFilePath(productKey) {
            const pathInput = document.getElementById('customPathValue_' + productKey);
            return pathInput.value.trim() || null;
        }
        
        // 显示配置结果
        function showConfigResult(data) {
            const resultDiv = document.getElementById('configResult');
            const contentDiv = document.getElementById('resultContent');
            
            let html = '';
            
            if (data.success) {
                html += `<div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>配置成功!</strong> ${data.message}
                </div>`;
                
                if (data.successProducts && data.successProducts.length > 0) {
                    html += `<h6><i class="fas fa-check text-success me-2"></i>成功配置的产品 (${data.successProducts.length}个):</h6>
                    <div class="row mb-3">`;
                    data.successProducts.forEach(product => {
                        html += `<div class="col-md-3 mb-1">
                            <span class="badge bg-success">${product}</span>
                        </div>`;
                    });
                    html += '</div>';
                }
                
                if (data.failedProducts && data.failedProducts.length > 0) {
                    html += `<h6><i class="fas fa-times text-danger me-2"></i>配置失败的产品 (${data.failedProducts.length}个):</h6>
                    <div class="row mb-3">`;
                    data.failedProducts.forEach(product => {
                        html += `<div class="col-md-3 mb-1">
                            <span class="badge bg-danger">${product}</span>
                        </div>`;
                    });
                    html += '</div>';
                }
                
                if (data.jarPath) {
                    html += `<p><strong>使用的jar路径:</strong> <code>${data.jarPath}</code></p>`;
                }
                
                html += `<div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>下一步:</strong> 请重启对应的JetBrains IDE，然后使用生成的许可证进行激活。
                </div>`;
            } else {
                html += `<div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>
                    <strong>配置失败!</strong> ${data.message}
                </div>`;
            }
            
            contentDiv.innerHTML = html;
            resultDiv.style.display = 'block';
            
            // 滚动到结果区域
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 初始化
        updateSelectionSummary();
    </script>
</body>
</html>
